<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gesti√≥n Intermodal</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#f3f6fc; --card:#fff; --primary:#007bff; --text:#222; --muted:#888; }
    [data-theme="dark"]{ --bg:#0f1724; --card:#0b1220; --primary:#60a5fa; --text:#e6eef8; --muted:#9aa7bf; }
    *{box-sizing:border-box} body{font-family:Inter,system-ui; background:var(--bg); color:var(--text); margin:0}
    header{background:var(--primary); color:#fff; padding:1rem 1.25rem; display:flex;align-items:center;justify-content:space-between}
    header h1{margin:0;font-size:1.1rem}
    main{max-width:1100px;margin:1.25rem auto;padding:1rem}
    .card{background:var(--card);border-radius:10px;padding:1rem;margin-bottom:1rem;box-shadow:0 6px 18px rgba(2,6,23,0.06)}
    input,select,button{padding:8px 10px;border:1px solid #e6eef8;border-radius:8px;margin:6px; font-size:0.95rem}
    button{background:var(--primary);color:#fff;border:none;cursor:pointer}
    button.alt{background:#6c757d}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px;border-bottom:1px solid rgba(0,0,0,0.06);text-align:left;font-size:0.95rem}
    th{background:rgba(0,0,0,0.02)}
    .actions button{margin-right:6px}
    .top-controls{display:flex;gap:10px;align-items:center}
    #adminPanel{display:none;padding:12px;border-radius:8px;background:rgba(0,0,0,0.02);margin-top:8px}
    #darkToggle{background:transparent;border:1px solid rgba(255,255,255,0.15);padding:6px 8px;border-radius:8px;color:#fff;cursor:pointer}
    .badge{display:inline-block;padding:2px 6px;border-radius:6px;background:#ffeeba;color:#7a4b00;font-weight:600;font-size:0.8rem}
    .excepcion-row{background: linear-gradient(90deg, rgba(255,248,225,0.6), transparent)}
    .hint{color:var(--muted);font-size:0.85rem}
    .small{font-size:0.85rem;color:var(--muted)}
    .hidden{display:none}
    .right{margin-left:auto}
    pre#csvLog{background:rgba(0,0,0,.05);padding:8px;border-radius:6px;max-height:120px;overflow-y:auto}
  </style>
</head>
<body>
<header>
  <h1>üì¶ Gesti√≥n Intermodal</h1>
  <div style="display:flex;align-items:center;gap:8px">
    <button id="darkToggle" title="Cambiar tema">üåì</button>
    <button id="adminBtn" title="Panel admin" style="background:#222;color:#fff;padding:6px 8px;border-radius:8px">üîí Admin</button>
  </div>
</header>

<main>
  <!-- BUSCAR -->
  <div class="card">
    <h3>üîç Buscar disponibilidad</h3>
    <div style="display:flex;flex-wrap:wrap;align-items:center">
      <input type="date" id="filtroFecha">
      <input type="text" id="filtroPuerto" placeholder="Puerto">
      <input type="text" id="filtroCliente" placeholder="Cliente">
      <input type="text" id="filtroLocalidad" placeholder="Localidad">
      <div style="margin-left:auto">
        <button id="btnBuscar">Buscar</button>
        <button id="btnLimpiarBusqueda" class="alt">üßπ Limpiar</button>
      </div>
    </div>
    <div class="small hint">Cliente+Localidad ‚Üí excepci√≥n; Fecha+Puerto ‚Üí stock general</div>
  </div>

  <!-- RESULTADOS -->
  <div id="disponibilidadCard" class="card hidden">
    <div style="display:flex;align-items:center">
      <h3>üìä Stock actual</h3>
      <div class="right" style="display:flex;gap:8px">
        <button id="exportCsv">‚¨áÔ∏è Exportar CSV</button>
        <button id="clearVisible" class="alt">üóëÔ∏è Borrar filas visibles</button>
      </div>
    </div>
    <table id="tabla-stock">
      <thead>
        <tr>
          <th>Proveedor</th>
          <th>Cliente</th>
          <th>Acuerdo</th>
          <th>Disponible</th>
          <th>Puerto</th>
          <th>Localidad</th>
          <th>Fecha</th>
          <th>Usuario</th>
          <th>Notas</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="noResults" class="small" style="display:none;margin-top:8px">No hay resultados.</div>
  </div>

  <!-- A√ëADIR / REDUCIR -->
  <div class="card">
    <h3>üöõ Gestionar Reserva üöõ</h3>
    <div style="display:flex;flex-wrap:wrap;align-items:center">
      <input type="text" id="proveedor" placeholder="Proveedor">
      <input type="text" id="cliente" placeholder="Cliente (vac√≠o = general)">
      <input type="number" id="cantidad" placeholder="-  suma  /  +  resta" style="width:150px">
      <input type="text" id="tn" placeholder="TN">
      <input type="date" id="fechaInput">
      <input type="text" id="puertoInput" placeholder="Puerto">
      <input type="text" id="localidadInput" placeholder="Localidad">
      <input type="text" id="usuarioInput" placeholder="Usuario">
      <div style="width:100%;display:flex;justify-content:flex-start;margin-top:6px">
        <button id="btnGuardar">Guardar cambios</button>
        <button id="btnLimpiarPrincipal" class="alt">üßπ Limpiar</button>
      </div>
    </div>
    <div class="small hint">Gestionar Reserva de Transporte</div>
  </div>

  <!-- ADMIN -->
  <div id="adminPanel" class="card">
    <h3>üîê Panel admin</h3>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="btnHistorial">Ver historial (movimientos)</button>
      <button id="btnExportAll">Exportar todo movimientos (CSV)</button>
      <button id="btnToggleMode" class="alt">Mostrar/Ocultar modo admin</button>
      <button id="btnFijarAcuerdosGeneral" class="alt">üîí Fijar Acuerdos (stockGeneral)</button>
      <button id="btnFijarFijoExcepciones" class="alt">üîí Fijar AsignadoFijo (excepciones)</button>
      <button id="btnReescribirBD" class="alt">üîÅ Reescribir BD con nueva estructura</button>
    </div>
    <div id="historial" style="margin-top:12px;display:none">
      <h4>Historial (√∫ltimos 200)</h4>
      <table id="tabla-movimientos">
        <thead><tr><th>Fecha</th><th>Proveedor</th><th>Delta</th><th>Usuario</th><th>TN</th><th>Notas</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <!-- FORMULARIO DE EXCEPCI√ìN (SIN TOCAR STOCK) -->
    <div class="card" style="margin-top:1rem">
      <h4>‚ûï Crear / editar excepci√≥n (sin modificar stock)</h4>
      <div style="display:flex;flex-wrap:wrap;align-items:center">
        <input type="text" id="admProveedor" placeholder="Proveedor">
        <input type="text" id="admCliente" placeholder="Cliente">
        <input type="text" id="admPuerto" placeholder="Puerto">
        <input type="text" id="admLocalidad" placeholder="Localidad">
        <input type="date" id="admFecha">
        <input type="number" id="admAcuerdo" placeholder="Acuerdo (fijo)" style="width:150px">
        <input type="number" id="admDisponibilidad" placeholder="Disponibilidad (variable)" style="width:150px">
        <input type="text" id="admTN" placeholder="TN">
        <input type="text" id="admNotas" placeholder="Notas">
        <input type="text" id="admUsuario" placeholder="Usuario">
        <label style="display:flex;align-items:center;margin-left:8px">
          <input type="checkbox" id="admModificaStock"> Modifica stock general
        </label>
        <div style="width:100%;display:flex;justify-content:flex-start;margin-top:6px">
          <button id="btnAdmGuardarEx">Guardar excepci√≥n</button>
          <button id="btnAdmLimpiarEx" class="alt">Limpiar</button>
        </div>
      </div>
      <div class="small hint">Si ¬´Modifica stock general¬ª est√° activado, la cantidad sumar√°/restar√°; si no, solo crea/actualiza la excepci√≥n.</div>
    </div>
    <!-- CARGA MASIVA CSV -->
    <div class="card" style="margin-top:1rem">
      <h4>üìÅ Carga masiva excepciones (CSV)</h4>
      <label style="font-size:0.9rem">Columnas: proveedor,cliente,puerto,localidad,fecha,acuerdo,disponibilidad,tn,notas,usuario</label>
      <input type="file" id="csvExcepciones" accept=".csv" style="margin-top:6px">
      <label style="display:flex;align-items:center;margin-top:8px">
        <input type="checkbox" id="modoPrueba" checked> üëÄ Modo prueba (solo validar, no subir)
      </label>
      <button id="btnSubirCsvEx" class="alt">Subir CSV</button>
      <button id="btnSubirCsvStock" class="alt" style="margin-left:8px">Subir CSV (solo stock general)</button>
      <pre id="csvLog" style="font-size:0.8rem;margin-top:8px;white-space:pre-wrap"></pre>
    </div>

<!-- CORREGIR CUALQUIER CAMPO (incluye cantidad) -->
<div class="card" style="margin-top:1rem">
  <h4>üîß Corregir excepciones (CSV)</h4>
  <label style="font-size:0.9rem">
    Formato: proveedor,puerto,fecha,cliente,localidadAnt,localidadNueva,acuerdoNuevo,disponibilidadNueva<br>
    (deja vac√≠o lo que NO quieras tocar)
  </label>
  <input type="file" id="csvCorregir" accept=".csv" style="margin-top:6px">
  <button id="btnCorregirEx" class="alt">Corregir excepciones</button>
  <pre id="corrLog" style="font-size:0.8rem;margin-top:8px;white-space:pre-wrap"></pre>
</div>

<!-- BORRAR MASIVO -->
<div class="card" style="margin-top:1rem">
  <h4>üóëÔ∏è Borrar masivamente (CSV)</h4>
  <label style="font-size:0.9rem">Formatato: proveedor,puerto,fecha,cliente,localidad</label>
  <input type="file" id="csvBorrar" accept=".csv" style="margin-top:6px">
  <button id="btnBorrarMasivo" class="alt" style="background:#dc3545">Borrar por CSV</button>
  <pre id="delLog" style="font-size:0.8rem;margin-top:8px;white-space:pre-wrap"></pre>
</div>
  </div>
</main>

<footer style="padding:12px;text-align:center;color:var(--muted)">Desarrollado por Hugo üß† | Firebase + Netlify</footer>

<script type="module">
  // 1. IMPORTS
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getFirestore, collection, getDocs, query, addDoc, doc, getDoc, setDoc, deleteDoc,
    orderBy, limit, where, writeBatch
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC8qPpRUTOP5Ef7pf4DYXkTCZnTWVQwHHU",
    authDomain: "gestion-stock-transportes.firebaseapp.com",
    projectId: "gestion-stock-transportes",
    storageBucket: "gestion-stock-transportes.appspot.com",
    messagingSenderId: "47030902783",
    appId: "1:47030902783:web:ec7217b290a3d2fbad91ca"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // 2. VARIABLES DOM
  const tablaBody       = document.querySelector("#tabla-stock tbody");
  const disponibilidadCard = document.getElementById("disponibilidadCard");
  const noResults       = document.getElementById("noResults");
  const btnBuscar       = document.getElementById("btnBuscar");
  const btnGuardar      = document.getElementById("btnGuardar");
  const btnLimpiarPrincipal = document.getElementById("btnLimpiarPrincipal");
  const btnLimpiarBusqueda  = document.getElementById("btnLimpiarBusqueda");
  const exportCsvBtn    = document.getElementById("exportCsv");
  const clearVisibleBtn = document.getElementById("clearVisible");
  const adminBtn        = document.getElementById("adminBtn");
  const adminPanel      = document.getElementById("adminPanel");
  const btnHistorial    = document.getElementById("btnHistorial");
  const historialDiv    = document.getElementById("historial");
  const tablaMov        = document.querySelector("#tabla-movimientos tbody");
  const btnExportAll    = document.getElementById("btnExportAll");
  const darkToggle      = document.getElementById("darkToggle");

  // 3. TEMA
  function applyTheme(theme) {
    if (theme === 'dark') document.documentElement.setAttribute('data-theme', 'dark');
    else document.documentElement.removeAttribute('data-theme');
    localStorage.setItem('theme', theme);
  }
  darkToggle.addEventListener('click', () => {
    const cur = localStorage.getItem('theme') === 'dark' ? 'light' : 'dark';
    applyTheme(cur);
  });
  applyTheme(localStorage.getItem('theme') || 'light');

  // 4. UTILS
  function csvFromArray(rows) {
    return rows.map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(",")).join("\n");
  }
  function downloadFile(name, content, type = 'text/csv') {
    const blob = new Blob([content], { type });
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement('a'), { href: url, download: name });
    a.click();
    URL.revokeObjectURL(url);
  }
  function norm(str) {
    return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toUpperCase().trim().replace(/[^A-Z0-9\/\+_]/g, '');
  }

  // 5. FUNCIONES PRINCIPALES
  async function buscarYMostrar() {
    tablaBody.innerHTML = "";
    noResults.style.display = 'none';
    const fecha     = document.getElementById("filtroFecha").value;
    const puertoRaw = document.getElementById("filtroPuerto").value.trim().toUpperCase();
    const clienteRaw= document.getElementById("filtroCliente").value.trim().toUpperCase();
    const localRaw  = document.getElementById("filtroLocalidad").value.trim().toUpperCase();

    if (clienteRaw && localRaw) {
      let qEx = collection(db, "excepciones");
      const constraintsEx = [];
      if (fecha)     constraintsEx.push(where("fecha",  "==", fecha));
      if (puertoRaw) constraintsEx.push(where("puerto", "==", puertoRaw));
      if (clienteRaw)constraintsEx.push(where("cliente","==",clienteRaw));
      if (localRaw)  constraintsEx.push(where("localidad","==",localRaw));
      qEx = query(qEx, ...constraintsEx);
      const snapEx = await getDocs(qEx);
      let found = false;
      for (const s of snapEx.docs) {
        const d = s.data();
        if ((d.puerto||'').toUpperCase().startsWith(puertoRaw) &&
            (d.cliente||'').toUpperCase().startsWith(clienteRaw) &&
            (d.localidad||'').toUpperCase().startsWith(localRaw)) {
          found = true;
          pintarFilaExcepcion(d, s.id);
        }
      }
      if (found) { disponibilidadCard.classList.remove('hidden'); return; }
    }

    let qGen = collection(db, "stockGeneral");
    const constraintsGen = [];
    if (fecha)     constraintsGen.push(where("fecha", "==", fecha));
    if (puertoRaw) constraintsGen.push(where("puerto", "==", puertoRaw));
    qGen = query(qGen, ...constraintsGen);
    const snapGen = await getDocs(qGen);
    let found = false;
    for (const s of snapGen.docs) {
      const d = s.data();
      if ((d.puerto||'').toUpperCase().startsWith(puertoRaw)) {
        found = true;
        await pintarFilaGeneral(d, s.id);
      }
    }
    if (found) { disponibilidadCard.classList.remove('hidden'); return; }
    noResults.style.display = 'block';
  }

  async function cantidadUsada(prov, pt, fec) {
    const q = query(collection(db, 'movimientos'), where('proveedor', '==', prov), where('puerto', '==', pt), where('fecha', '==', fec), where('delta', '<', 0));
    const snap = await getDocs(q);
    let usado = 0;
    snap.forEach(doc => { usado += Math.abs(doc.data().delta || 0); });
    return usado;
  }

  async function pintarFilaGeneral(d, id) {
    const consumido = await cantidadUsada(d.proveedor, d.puerto, d.fecha);
    const saldo = (d.disponibilidad ?? 0);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${d.proveedor || ''}</td>
      <td>-</td>
      <td>${d.acuerdo ?? ''}</td>
      <td>${saldo}</td>
      <td>${d.puerto || ''}</td>
      <td>-</td>
      <td>${d.fecha || ''}</td>
      <td>${d.usuario || ''}</td>
      <td></td>
      <td class="actions"><button class="btnEliminarGeneral" data-id="${id}" style="background:#dc3545">‚ùå</button></td>`;
    tablaBody.appendChild(tr);
  }

  function pintarFilaExcepcion(d, id) {
  const tr = document.createElement('tr');
  tr.classList.add('excepcion-row');  // ‚úÖ aqu√≠ va "tr"
  const acuerdo = d.acuerdo ?? d.asignadoFijo ?? d.asignado ?? 0;
  const disp  = d.disponibilidad ?? d.asignado ?? 0;
  tr.innerHTML = `
    <td>${d.proveedor || ''} <span class="badge">Excepci√≥n</span></td>
    <td>${d.cliente || ''}</td>
    <td>${acuerdo}</td>
    <td>${disp}</td>
    <td>${d.puerto || ''}</td>
    <td>${d.localidad || ''}</td>
    <td>${d.fecha || ''}</td>
    <td>${d.usuario || ''}</td>
    <td>${d.notasAcum || ''}</td>
    <td class="actions"><button class="btnEliminarExcepcion" data-id="${id}" style="background:#dc3545">‚ùå</button></td>`;
  tablaBody.appendChild(tr);
}

  // 6. EVENTOS
  btnBuscar.addEventListener('click', buscarYMostrar);
  document.addEventListener('click', async (e) => {
    if (e.target.classList.contains('btnEliminarGeneral')) {
      if (!confirm('¬øEliminar stock general?')) return;
      await deleteDoc(doc(db, 'stockGeneral', e.target.dataset.id));
      e.target.closest('tr').remove();
    }
    if (e.target.classList.contains('btnEliminarExcepcion')) {
      if (!confirm('¬øEliminar excepci√≥n? (No se devuelve al stock)')) return;
      await deleteDoc(doc(db, 'excepciones', e.target.dataset.id));
      e.target.closest('tr').remove();
    }
  });

  // ---------- GUARDAR ----------
  btnGuardar.addEventListener('click', async () => {
    try {
      console.log('üîò Click en Guardar');
      const proveedor = norm(document.getElementById('proveedor').value.trim());
      const cliente   = norm(document.getElementById('cliente').value);
      let cantidadRaw = parseInt(document.getElementById('cantidad').value);
      console.log('üîç cantidadRaw introducido', cantidadRaw);
      if (isNaN(cantidadRaw)) { alert('Cantidad inv√°lida'); return; }
      const cantidad  = -cantidadRaw;
      console.log('üîç cantidad tras cambio de signo', cantidad, '¬øes aumento?', cantidad > 0, '¬øes reducci√≥n?', cantidad < 0);
      const tnActual  = document.getElementById('tn').value.trim() || '';
      const fecha     = document.getElementById('fechaInput').value;
      const puerto    = norm(document.getElementById('puertoInput').value);
      const localidad = norm(document.getElementById('localidadInput').value);
      const usuario   = document.getElementById('usuarioInput').value.trim() || '';
      if (!proveedor || !fecha) { alert('Completa proveedor y fecha'); return; }
      const esExcepcion = !!(cliente && localidad);
      const batch       = writeBatch(db);
      const genId  = `${norm(proveedor)}::${fecha}::${puerto}`;
      const genRef = doc(db, 'stockGeneral', genId);
      const genSnap= await getDoc(genRef);
      let dispActual   = genSnap.exists() ? (genSnap.data().disponibilidad ?? 0) : 0;
      const nuevoDisponible = dispActual + cantidad;
      const updateData = {
        proveedor, proveedorNorm: norm(proveedor),
        fecha, puerto, puertoNorm: puerto,
        disponibilidad: nuevoDisponible,
        usuario: usuario || '', tn: ''
      };
      if (!genSnap.exists() || genSnap.data().acuerdo === undefined) {
        updateData.acuerdo = nuevoDisponible; // solo la primera vez
      }
      batch.set(genRef, updateData, { merge: true });
      if (cantidad < 0) {
        const qEx = query(collection(db, 'excepciones'), where('proveedor', '==', proveedor), where('fecha', '==', fecha), where('puerto', '==', puerto));
        const excepcionesSnap = await getDocs(qEx);
        for (const exDoc of excepcionesSnap.docs) {
          const exData = exDoc.data();
          const nuevoDisponibleEx = Math.max(0, (exData.disponibilidad || 0) + cantidad);
          batch.set(exDoc.ref, { disponibilidad: nuevoDisponibleEx }, { merge: true });
        }
      }
      if (cantidad > 0) {
        const qEx = query(
  collection(db, 'excepciones'),
  where('proveedor', '==', proveedor),
  where('fecha', '==', fecha),
  where('puerto', '==', puerto)
);
const excepcionesSnap = await getDocs(qEx);
for (const exDoc of excepcionesSnap.docs) {
  const exData = exDoc.data();
  const nuevoDisponibleEx = cantidad < 0
    ? Math.max(0, (exData.disponibilidad ?? exData.asignado ?? 0) + cantidad)
    : (exData.disponibilidad ?? exData.asignado ?? 0) + cantidad;
  batch.set(exDoc.ref, { disponibilidad: nuevoDisponibleEx }, { merge: true });
}
      }
      if (esExcepcion) {
        const exId  = `${norm(proveedor)}::${fecha}::${puerto}::${cliente}::${localidad}`;
        const exRef = doc(db, 'excepciones', exId);
        const exSnap= await getDoc(exRef);
        let dispActualEx = exSnap.exists() ? (exSnap.data().disponibilidad ?? 0) : 0;
        let acuerdoEx    = exSnap.exists() ? (exSnap.data().acuerdo ?? dispActualEx) : 0;
        const nuevoDisponibleEx = dispActualEx + cantidad;
        let tnAcum   = exSnap.exists() ? (exSnap.data().tnAcum || '') : '';
        let notasAcum= exSnap.exists() ? (exSnap.data().notasAcum || '') : '';
        if (tnActual)   tnAcum += (tnAcum ? ' | ' : '') + `${tnActual}`;
        batch.set(exRef, {
          proveedor, proveedorNorm: norm(proveedor),
          cliente,   clienteNorm:   cliente,
          fecha,     puerto,        puertoNorm: puerto,
          localidad, localidadNorm: localidad,
          acuerdo: acuerdoEx,
          disponibilidad: nuevoDisponibleEx,
          usuario: usuario || '',
          tnAcum: tnAcum,
          notasAcum: notasAcum
        }, { merge: true });
        console.log('üíæ Commit con excepci√≥n individual');
        await batch.commit();
        alert('‚úÖ Stock general y excepci√≥n actualizados.');
        await buscarYMostrar();
        return;
      }
      console.log('üíæ Commit solo stock general');
      await batch.commit();
      alert('‚úÖ Stock general actualizado.');
      await buscarYMostrar();
    } catch (err) {
      console.error('üí• Error en btnGuardar:', err);
      alert('Error al guardar: ' + err.message);
    }
  });

  // 7. M√ÅS EVENTOS
  btnLimpiarPrincipal.addEventListener('click', () => {
    document.querySelectorAll('#proveedor,#cliente,#cantidad,#tn,#fechaInput,#puertoInput,#localidadInput,#usuarioInput').forEach(i => i.value = '');
  });
  btnLimpiarBusqueda.addEventListener('click', () => {
    document.querySelectorAll('#filtroFecha,#filtroPuerto,#filtroCliente,#filtroLocalidad').forEach(i => i.value = '');
    tablaBody.innerHTML = '';
    disponibilidadCard.classList.add('hidden');
    noResults.style.display = 'none';
  });
  exportCsvBtn.addEventListener('click', () => {
    const rows = [['Proveedor', 'Cliente', 'Acuerdo', 'Disponible', 'Puerto', 'Localidad', 'Fecha', 'Usuario', 'Notas']];
    document.querySelectorAll('#tabla-stock tbody tr').forEach(tr => {
      const cols = Array.from(tr.querySelectorAll('td')).slice(0, 9).map(td => td.textContent.trim());
      if (cols.length) rows.push(cols);
    });
    downloadFile('disponibilidad.csv', csvFromArray(rows));
  });
  clearVisibleBtn.addEventListener('click', async () => {
    if (!confirm('¬øBorrar todos los registros visibles en la tabla? (Esto eliminar√° los documentos en Firestore)')) return;
    const btnsGen = document.querySelectorAll('#tabla-stock tbody .btnEliminarGeneral');
    const btnsEx  = document.querySelectorAll('#tabla-stock tbody .btnEliminarExcepcion');
    for (const b of [...btnsGen, ...btnsEx]) {
      const coleccion = b.classList.contains('btnEliminarGeneral') ? 'stockGeneral' : 'excepciones';
      await deleteDoc(doc(db, coleccion, b.dataset.id));
      b.closest('tr').remove();
    }
    if (!document.querySelectorAll('#tabla-stock tbody tr').length) disponibilidadCard.classList.add('hidden');
    alert('üóëÔ∏è Filas visibles eliminadas.');
  });

  // 8. ADMIN
  adminBtn.addEventListener('click', async () => {
    const pw = prompt('Introduce contrase√±a admin:');
    if (pw === 'admin123') {
      adminPanel.style.display = adminPanel.style.display === 'block' ? 'none' : 'block';
    } else {
      alert('Contrase√±a incorrecta.');
    }
  });

  // 9. BOTONES NUEVOS (fijar campos)
  document.getElementById('btnFijarAcuerdosGeneral').addEventListener('click', async () => {
    if (!confirm('¬øFijar campo "acuerdo" al valor actual de "disponibilidad" en TODOS los stockGeneral?')) return;
    console.log('üîí Fijando acuerdos en stockGeneral...');
    const snap = await getDocs(collection(db, 'stockGeneral'));
    let ok = 0, err = 0;
    for (const docSnap of snap.docs) {
      const data = docSnap.data();
      const disp = data.disponibilidad ?? 0;
      const tieneAcuerdo = data.acuerdo !== undefined;
      if (!tieneAcuerdo) {
        try {
          await setDoc(docSnap.ref, { acuerdo: disp }, { merge: true });
          console.log('‚úÖ stockGeneral', docSnap.id, 'acuerdo =', disp);
          ok++;
        } catch (e) {
          console.warn('‚ùå Error stockGeneral', docSnap.id, e);
          err++;
        }
      } else {
        console.log('‚è≠Ô∏è stockGeneral ya tiene acuerdo', docSnap.id);
      }
    }
    alert(`stockGeneral fijados: ${ok}. Errores: ${err}`);
  });

  document.getElementById('btnFijarFijoExcepciones').addEventListener('click', async () => {
    if (!confirm('¬øFijar campo "asignadoFijo" al valor actual de "asignado" en TODAS las excepciones?')) return;
    console.log('üîí Fijando asignadoFijo en excepciones...');
    const snap = await getDocs(collection(db, 'excepciones'));
    let ok = 0, err = 0;
    for (const docSnap of snap.docs) {
      const data = docSnap.data();
      const asig = data.asignado ?? 0;
      const tieneFijo = data.asignadoFijo !== undefined;
      if (!tieneFijo) {
        try {
          await setDoc(docSnap.ref, { asignadoFijo: asig }, { merge: true });
          console.log('‚úÖ excepci√≥n', docSnap.id, 'asignadoFijo =', asig);
          ok++;
        } catch (e) {
          console.warn('‚ùå Error excepci√≥n', docSnap.id, e);
          err++;
        }
      } else {
        console.log('‚è≠Ô∏è excepci√≥n ya tiene asignadoFijo', docSnap.id);
      }
    }
    alert(`Excepciones fijadas: ${ok}. Errores: ${err}`);
  });

  // 10. MIGRACI√ìN: REESCRIBIR EXCEPCIONES CON NUEVA ESTRUCTURA
  document.getElementById('btnReescribirBD').addEventListener('click', async () => {
    if (!confirm('‚ö†Ô∏è ESTO REESCRIBIR√Å TODAS LAS EXCEPCIONES CON LA NUEVA ESTRUCTURA (Acuerdo + Disponibilidad).\n\nSe mantendr√°n los valores anteriores como "Acuerdo fijo" y se copiar√°n como "Disponibilidad inicial".\n\n¬øContinuar?')) return;

    console.log('üîÅ Iniciando reescritura de excepciones...');
    const snap = await getDocs(collection(db, 'excepciones'));
    let ok = 0, err = 0;

    for (const docSnap of snap.docs) {
      const data = docSnap.data();
      const acuerdo = data.acuerdo ?? data.asignadoFijo ?? data.asignado ?? 0;
      const disp  = data.disponibilidad ?? data.asignado ?? 0;

      try {
        await setDoc(docSnap.ref, {
          acuerdo: acuerdo,
          disponibilidad: disp,
          // mantener el resto
          proveedor: data.proveedor,
          cliente: data.cliente,
          fecha: data.fecha,
          puerto: data.puerto,
          localidad: data.localidad,
          usuario: data.usuario || '',
          tnAcum: data.tnAcum || '',
          notasAcum: data.notasAcum || ''
        }, { merge: true });
        console.log('‚úÖ Reescrita excepci√≥n', docSnap.id);
        ok++;
      } catch (e) {
        console.warn('‚ùå Error reescribiendo', docSnap.id, e);
        err++;
      }
    }

    alert(`‚úÖ Reescritura finalizada.\nExcepciones actualizadas: ${ok}.\nErrores: ${err}.\n\nAhora puedes sumar/restar sin tocar "Acuerdo".`);
    await buscarYMostrar();
  });

  // ---------- FORMULARIO ADMIN DE EXCEPCI√ìN ----------
  const btnAdmGuardarEx = document.getElementById('btnAdmGuardarEx');
  const btnAdmLimpiarEx = document.getElementById('btnAdmLimpiarEx');

  btnAdmGuardarEx.addEventListener('click', async () => {
    const proveedor = norm(document.getElementById('proveedor').value.trim());
    const cliente   = norm(document.getElementById('admCliente').value);
    const puerto    = norm(document.getElementById('admPuerto').value);
    const localidad = norm(document.getElementById('admLocalidad').value);
    const fecha     = document.getElementById('admFecha').value;
    const acuerdo   = parseInt(document.getElementById('admAcuerdo').value);
    const disp      = parseInt(document.getElementById('admDisponibilidad').value);
    const tn        = document.getElementById('admTN').value.trim() || '';
    const notas     = document.getElementById('admNotas').value.trim() || '';
    const usuario   = document.getElementById('admUsuario').value.trim() || '';
    const modifica  = document.getElementById('admModificaStock').checked;

    if (!proveedor || !cliente || !localidad || !fecha || isNaN(acuerdo) || isNaN(disp)) {
      alert('Completa proveedor, cliente, localidad, fecha, acuerdo y disponibilidad'); return;
    }

    const batch = writeBatch(db);
    const genId  = `${norm(proveedor)}::${fecha}::${puerto}`;
    const genRef = doc(db, 'stockGeneral', genId);
    const exId   = `${norm(proveedor)}::${fecha}::${puerto}::${cliente}::${localidad}`;
    const exRef  = doc(db, 'excepciones', exId);

    if (modifica) {
      const genSnap = await getDoc(genRef);
      let dispGeneral = genSnap.exists() ? (genSnap.data().disponibilidad || 0) : 0;
      const nuevoGeneral = dispGeneral + disp;
      if (nuevoGeneral < 0) { alert('Stock insuficiente'); return; }
      batch.set(genRef, {
        proveedor, proveedorNorm: norm(proveedor),
        fecha, puerto, puertoNorm: puerto,
        disponibilidad: nuevoGeneral,
        usuario: usuario || '', tn: ''
      }, { merge: true });
    }

    const exSnap = await getDoc(exRef);
    let tnAcum   = exSnap.exists() ? (exSnap.data().tnAcum || '') : '';
    let notasAcum= exSnap.exists() ? (exSnap.data().notasAcum || '') : '';
    if (tn)   tnAcum   += (tnAcum   ? ' | ' : '') + tn;
    if (notas) notasAcum += (notasAcum ? ' | ' : '') + notas;

    batch.set(exRef, {
      proveedor, proveedorNorm: norm(proveedor),
      cliente,   clienteNorm:   cliente,
      fecha,     puerto,        puertoNorm: puerto,
      localidad, localidadNorm: localidad,
      acuerdo: acuerdo,
      disponibilidad: disp,
      usuario: usuario || '',
      tnAcum, notasAcum
    }, { merge: true });

    await batch.commit();
    alert(modifica ? '‚úÖ Excepci√≥n creada y stock actualizado.' : '‚úÖ Excepci√≥n creada sin tocar stock.');
    await buscarYMostrar();
  });

  btnAdmLimpiarEx.addEventListener('click', () => {
    document.querySelectorAll('#admProveedor,#admCliente,#admPuerto,#admLocalidad,#admFecha,#admAcuerdo,#admDisponibilidad,#admTN,#admNotas,#admUsuario').forEach(i => i.value = '');
    document.getElementById('admModificaStock').checked = false;
  });

  // ---------- CARGA MASIVA EXCEPCIONES (CSV) ----------
  document.getElementById('btnSubirCsvEx').addEventListener('click', async () => {
    const file = document.getElementById('csvExcepciones').files[0];
    if (!file) { alert('Selecciona un archivo CSV'); return; }
    const log = document.getElementById('csvLog');
    log.textContent = 'Procesando EXCEPCIONES...\n';
    const text = await file.text();
    const lines = text.split(/\r?\n/).filter(l => l.trim());
    const headers = lines.shift().split(',').map(h => h.trim().toLowerCase().replace(/\s+/g,''));
    const required = ['proveedor','cliente','puerto','localidad','fecha','acuerdo','disponibilidad'];
    const missing = required.filter(h => !headers.includes(h));
    if (missing.length) { log.textContent = `‚ùå Faltan columnas: ${missing.join(', ')}`; return; }
    let batch = writeBatch(db); let ok = 0, err = 0;
    for (const raw of lines) {
      const cols = raw.split(/[,;]/).map(c => c.trim().replace(/^"+|"+$/g, ''));
      const row = {}; headers.forEach((h, i) => row[h] = cols[i] || '');
      const proveedor       = row.proveedor;
      const clienteOriginal = row.cliente.trim();
      const clienteNorm     = norm(clienteOriginal);
      const puerto          = norm(row.puerto);
      const localidadOriginal = row.localidad.trim();
      const localidadNorm     = norm(localidadOriginal);
      let fecha = row.fecha.trim().replace(/"/g, '');
      if (fecha.includes('/')) { const [d, m, a] = fecha.split('/'); fecha = `${a}-${m}-${d}`; }
      const acuerdo = parseInt(row.acuerdo);
      const disp    = parseInt(row.disponibilidad);
      const tn        = row.tn || '';
      const notas     = row.notas || '';
      const usuario   = row.usuario || '';
      if (!proveedor || !clienteOriginal || !localidadOriginal || !fecha || isNaN(acuerdo) || isNaN(disp)) { err++; continue; }
      const exId   = `${norm(proveedor)}::${fecha}::${norm(puerto)}::${clienteNorm}::${localidadNorm}`;
      const exRef  = doc(db, 'excepciones', exId);
      if (document.getElementById('modoPrueba')?.checked) {
        console.log('ID excepci√≥n:', exId, 'datos:', { acuerdo, disponibilidad: disp, fecha, cliente: clienteOriginal, puerto, localidad: localidadOriginal, proveedor });
        ok++; continue;
      }
      let tnAcum   = '', notasAcum = '';
      if (tn)   tnAcum   += tn;
      if (notas) notasAcum += notas;
      batch.set(exRef, {
        proveedor,
        cliente     : clienteOriginal,
        clienteNorm : clienteNorm,
        fecha,
        puerto,
        puertoNorm  : norm(puerto),
        localidad   : localidadOriginal,
        localidadNorm: localidadNorm,
        acuerdo: acuerdo,
        disponibilidad: disp,
        usuario: usuario || '',
        tnAcum, notasAcum
      }, { merge: true });
      ok++;
      if ((ok + err) % 450 === 0) { await batch.commit(); batch = writeBatch(db); }
    }
    if (!document.getElementById('modoPrueba')?.checked) {
      try { await batch.commit(); } catch (e) { log.textContent += 'Error final: ' + e.message; }
    }
    log.textContent = `‚úÖ ${ok} excepciones procesadas. ‚ùå ${err} errores.`;
    if (!document.getElementById('modoPrueba')?.checked) await buscarYMostrar();
  });

  // ---------- CARGA MASIVA STOCK GENERAL ----------
  document.getElementById('btnSubirCsvStock').addEventListener('click', async () => {
    const file = document.getElementById('csvExcepciones').files[0];
    if (!file) { alert('Selecciona un archivo CSV'); return; }
    const log = document.getElementById('csvLog');
    log.textContent = 'Procesando STOCK GENERAL...\n';
    const text = await file.text();
    const lines = text.split(/\r?\n/).filter(l => l.trim());
    const headers = lines.shift().split(',').map(h => h.trim().toLowerCase().replace(/\s+/g,''));
    const required = ['proveedor','puerto','fecha','disponibilidad'];
    const missing = required.filter(h => !headers.includes(h));
    if (missing.length) { log.textContent = `‚ùå Faltan columnas: ${missing.join(', ')}`; return; }
    let batch = writeBatch(db); let ok = 0, err = 0;
    for (const raw of lines) {
      const cols = raw.split(/[,;]/).map(c => c.trim().replace(/^"+|"+$/g, ''));
      const row = {}; headers.forEach((h, i) => row[h] = cols[i] || '');
      const proveedor = row.proveedor.trim();
      const puerto    = norm(row.puerto);
      let fecha = row.fecha.trim().replace(/"/g, '');
      if (fecha.includes('/')) { const [d, m, a] = fecha.split('/'); fecha = `${a}-${m}-${d}`; }
      const disp = parseInt(row.disponibilidad);
      const usuario = row.usuario || '';
      const tn = row.tn || '';
      const notas = row.notas || '';
      if (!proveedor || !puerto || !fecha || isNaN(disp) || row.cliente || row.localidad) { err++; continue; }
      const genId  = `${norm(proveedor)}::${fecha}::${puerto}`;
      const genRef = doc(db, 'stockGeneral', genId);
      const snap = await getDoc(genRef);
      const dispActual = snap.exists() ? (snap.data().disponibilidad || 0) : 0;
      const nuevaDisp  = dispActual + disp;
      if (document.getElementById('modoPrueba')?.checked) {
        console.log('ID stock:', genId, 'delta:', disp, 'nuevo:', nuevaDisp);
        ok++; continue;
      }
      batch.set(genRef, {
        proveedor,
        proveedorNorm: norm(proveedor),
        fecha,
        puerto,
        puertoNorm: puerto,
        disponibilidad: nuevaDisp,
        usuario,
        tn
      }, { merge: true });
      ok++;
      if ((ok + err) % 450 === 0) { await batch.commit(); batch = writeBatch(db); }
    }
    if (!document.getElementById('modoPrueba')?.checked) {
      try { await batch.commit(); } catch (e) { log.textContent += 'Error final: ' + e.message; }
    }
    log.textContent = `‚úÖ ${ok} stocks procesados. ‚ùå ${err} filas descartadas.`;
    if (!document.getElementById('modoPrueba')?.checked) await buscarYMostrar();
  });

  // ---------- CORREGIR / BORRAR MASIVO ----------
  document.getElementById('btnCorregirEx').addEventListener('click', async () => {
    const file = document.getElementById('csvCorregir').files[0];
    if (!file) { alert('Selecciona el CSV de correcci√≥n'); return; }
    const log = document.getElementById('corrLog');
    log.textContent = 'Corrigiendo...\n';
    const text = await file.text();
    const lines = text.split(/\r?\n/).filter(l => l.trim());
    const headers = lines.shift().split(',').map(h => h.trim().toLowerCase());
    const reqId = ['proveedor','puerto','fecha','cliente','localidadant','localidadnueva'];
    const miss = reqId.filter(h => !headers.includes(h));
    if (miss.length) { log.textContent = `‚ùå Faltan: ${miss.join(', ')}`; return; }
    let ok = 0, err = 0;
    for (const raw of lines) {
      const cols = raw.split(/[,;]/).map(c => c.trim().replace(/^"+|"+$/g, ''));
      if (cols.length < reqId.length) { err++; continue; }
      const [prov, pt, fec, cli, locAnt, locNue] = cols.slice(0, 6);
      const acuerdoNuevo = cols[6] ? parseInt(cols[6]) : null;
      const dispNueva    = cols[7] ? parseInt(cols[7]) : null;
      if (!prov || !pt || !fec || !cli || !locAnt || !locNue) { err++; continue; }
      const fecha = fec.includes('/') ? fec.split('/').reverse().join('-') : fec;
      const exId = `${norm(prov)}::${fecha}::${norm(pt)}::${norm(cli)}::${norm(locAnt)}`;
      const ref = doc(db, 'excepciones', exId);
      const snap = await getDoc(ref);
      if (!snap.exists()) { err++; continue; }
      const cambios = { localidad: locNue.trim(), localidadNorm: norm(locNue) };
      if (!isNaN(acuerdoNuevo)) cambios.acuerdo = acuerdoNuevo;
      if (!isNaN(dispNueva))    cambios.disponibilidad = dispNueva;
      await setDoc(ref, cambios, { merge: true });
      ok++;
    }
    log.textContent = `‚úÖ ${ok} excepciones corregidas. ‚ùå ${err} errores.`;
    await buscarYMostrar();
  });

  document.getElementById('btnBorrarMasivo').addEventListener('click', async () => {
    const file = document.getElementById('csvBorrar').files[0];
    if (!file) { alert('Selecciona el CSV a borrar'); return; }
    if (!confirm('‚ö†Ô∏è Vas a BORRAR los documentos del CSV. ¬øContinuar?')) return;
    const log = document.getElementById('delLog');
    log.textContent = 'Borrando...\n';
    const text = await file.text();
    const lines = text.split(/\r?\n/).filter(l => l.trim());
    const headers = lines.shift().split(',').map(h => h.trim().toLowerCase());
    const req = ['proveedor','puerto','fecha','cliente','localidad'];
    const miss = req.filter(h => !headers.includes(h));
    if (miss.length) { log.textContent = `‚ùå Faltan: ${miss.join(', ')}`; return; }
    let ok = 0, err = 0;
    for (const raw of lines) {
      const cols = raw.split(/[,;]/).map(c => c.trim().replace(/^"+|"+$/g, ''));
      if (cols.length < req.length) { err++; continue; }
      const [prov, pt, fec, cli, loc] = cols;
      if (!prov || !pt || !fec || !cli || !loc) { err++; continue; }
      const fecha = fec.includes('/') ? fec.split('/').reverse().join('-') : fec;
      const exId = `${norm(prov)}::${fecha}::${norm(pt)}::${norm(cli)}::${norm(loc)}`;
      try {
        await deleteDoc(doc(db, 'excepciones', exId));
        ok++;
      } catch (e) {
        err++;
      }
    }
    log.textContent = `üóëÔ∏è ${ok} borrados. ‚ùå ${err} errores.`;
    await buscarYMostrar();
  });

console.log('norm("avanza") =', norm("avanza"));
console.log('norm("AVANZA") =', norm("AVANZA"));
console.log('norm(" Avanza ") =', norm(" Avanza "));

  // Inicial
  adminPanel.style.display = 'none';
</script>
</body>
</html>
