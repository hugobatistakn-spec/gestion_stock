<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gesti√≥n Intermodal</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#f3f6fc; --card:#fff; --primary:#007bff; --text:#222; --muted:#888; }
    [data-theme="dark"]{ --bg:#0f1724; --card:#0b1220; --primary:#60a5fa; --text:#e6eef8; --muted:#9aa7bf; }
    th:nth-child(4), td:nth-child(4) {
      font-weight: 600;
      font-size: 1.1rem;
      color: #0a5c36;
      background-color: #d4f8e0;
    }
    *{box-sizing:border-box} body{font-family:Inter,system-ui; background:var(--bg); color:var(--text); margin:0}
    header{background:var(--primary); color:#fff; padding:1rem 1.25rem; display:flex;align-items:center;justify-content:space-between}
    header h1{margin:0;font-size:1.1rem}
    main{max-width:1100px;margin:1.25rem auto;padding:1rem}
    .card{background:var(--card);border-radius:10px;padding:1rem;margin-bottom:1rem;box-shadow:0 6px 18px rgba(2,6,23,0.06)}
    input,select,button{padding:8px 10px;border:1px solid #e6eef8;border-radius:8px;margin:6px; font-size:0.95rem}
    button{background:var(--primary);color:#fff;border:none;cursor:pointer}
    button.alt{background:#6c757d}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px;border-bottom:1px solid rgba(0,0,0,0.06);text-align:left;font-size:0.95rem}
    th{background:rgba(0,0,0,0.02)}
    .actions button{margin-right:6px}
    .top-controls{display:flex;gap:10px;align-items:center}
    #adminPanel{display:none;padding:12px;border-radius:8px;background:rgba(0,0,0,0.02);margin-top:8px}
    #darkToggle{background:transparent;border:1px solid rgba(255,255,255,0.15);padding:6px 8px;border-radius:8px;color:#fff;cursor:pointer}
    .badge{display:inline-block;padding:2px 6px;border-radius:6px;background:#ffeeba;color:#7a4b00;font-weight:600;font-size:0.8rem}
    .excepcion-row{background: linear-gradient(90deg, rgba(255,248,225,0.6), transparent)}
    .hint{color:var(--muted);font-size:0.85rem}
    .small{font-size:0.85rem;color:var(--muted)}
    .hidden{display:none}
    .right{margin-left:auto}
    pre#csvLog{background:rgba(0,0,0,.05);padding:8px;border-radius:6px;max-height:120px;overflow-y:auto}
  </style>
</head>
<body>
<header>
  <h1>üì¶ Gesti√≥n Intermodal</h1>
  <div style="display:flex;align-items:center;gap:8px">
    <button id="darkToggle" title="Cambiar tema">üåì</button>
    <button id="adminBtn" title="Panel admin" style="background:#222;color:#fff;padding:6px 8px;border-radius:8px">üîí Admin</button>
  </div>
</header>

<main>
  <!-- BUSCAR -->
  <div class="card">
  <h3>üîç Buscar disponibilidad</h3>
  <div style="display:flex;flex-wrap:wrap;align-items:center">
    <input type="date" id="filtroFecha">
    <select id="filtroPuerto">
      <option value="">Puerto</option>
      <option value="ESBIO">ESBIO</option>
      <option value="ESVGO">ESVGO</option>
      <option value="ESVLC">ESVLC</option>
      <option value="ESBCN">ESBCN</option>
      <option value="ESALG">ESALG</option>
    </select>
    <div style="margin-left:auto">
      <button id="btnBuscar">Buscar</button>
      <button id="btnLimpiarBusqueda" class="alt">üßπ Limpiar</button>
    </div>
  </div>
  <div class="small hint">Fecha+Puerto ‚Üí stock general</div>
</div>

  <!-- RESULTADOS -->
  <div id="disponibilidadCard" class="card hidden">
    <div style="display:flex;align-items:center">
      <h3>üìä Stock actual</h3>
      <div class="right" style="display:flex;gap:8px">
        <button id="exportCsv">‚¨áÔ∏è Exportar CSV</button>
        <button id="clearVisible" class="alt">üóëÔ∏è Borrar filas visibles</button>
      </div>
    </div>
    <table id="tabla-stock">
      <thead>
  <tr>
    <th>Proveedor</th>
    <th>Acuerdo</th>
    <th>Disponible</th>
    <th>Puerto</th>
    <th>Localidad</th>
    <th>Fecha</th>
    <th>Usuario</th>
    <th>Acciones</th>
  </tr>
</thead>
      <tbody></tbody>
    </table>
    <div id="noResults" class="small" style="display:none;margin-top:8px">No hay resultados.</div>
  </div>

  <!-- A√ëADIR / REDUCIR ‚Äì oculto hasta Buscar -->
<div id="reservaCard" class="card hidden">
  <h3>üöõ Gestionar Reserva üöõ</h3>
  <div style="display:flex;flex-wrap:wrap;align-items:center">
    <select id="proveedor" placeholder="Proveedor"></select>
    <input type="number" id="cantidad" placeholder="-  suma  /  +  resta" style="width:150px">
    <input type="date" id="fechaInput">
    <select id="puertoInput"></select>
    <input type="text" id="usuarioInput" placeholder="Usuario">
    <div style="width:100%;display:flex;justify-content:flex-start;margin-top:6px">
      <button id="btnGuardar">Guardar cambios</button>
      <button id="btnLimpiarPrincipal" class="alt">üßπ Limpiar</button>
    </div>
  </div>
  <div class="small hint">Gestionar Reserva de Transporte</div>
</div>

  <!-- ADMIN -->
  <div id="adminPanel" class="card">
    <h3>üîê Panel admin</h3>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="btnHistorial">Ver historial (movimientos)</button>
      <button id="btnExportAll">Exportar todo movimientos (CSV)</button>
      <button id="btnToggleMode" class="alt">Mostrar/Ocultar modo admin</button>
      <button id="btnFijarAcuerdosGeneral" class="alt">üîí Fijar Acuerdos (stockGeneral)</button>
      <button id="btnFijarFijoExcepciones" class="alt">üîí Fijar AsignadoFijo (excepciones)</button>
      <button id="btnReescribirBD" class="alt">üîÅ Reescribir BD con nueva estructura</button>
    </div>
    <div id="historial" style="margin-top:12px;display:none">
      <h4>Historial (√∫ltimos 200)</h4>
      <table id="tabla-movimientos">
        <thead>
  <tr>
    <th>Fecha</th>
    <th>Puerto</th>
    <th>Proveedor</th>
    <th>Movimiento</th>
    <th>Cantidad</th>
    <th>Usuario</th>
  </tr>
</thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Modal confirm colorido -->
  <div id="modalConfirm" class="hidden" style="position:fixed;z-index:9999;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.55);font-family:Inter;align-items:center;justify-content:center;">
    <div style="background:#fff;margin:auto;padding:25px;border-radius:12px;width:90%;max-width:1200px;height:auto;max-height:80%;overflow:auto;box-shadow:0 10px 30px rgba(0,0,0,0.25);zoom:0.8;">
      <h3 style="margin-top:0;color:#007bff;">üìå Excepciones encontradas</h3>
      <table id="tablaConfirmEx" style="width:100%;border-collapse:collapse;font-size:0.75rem;color:#222;">
        <thead>
          <tr style="background:#e6f2ff;">
            <th style="padding:6px;border:1px solid #ccc;">Cliente</th>
            <th style="padding:6px;border:1px solid #ccc;">Proveedor</th>
            <th style="padding:6px;border:1px solid #ccc;">Acuerdo</th>
            <th style="padding:6px;border:1px solid #ccc;background:#d4f8e0;">Disponible</th>
            <th style="padding:6px;border:1px solid #ccc;">Localidad</th>
            <th style="padding:6px;border:1px solid #ccc;">Notas</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div style="margin-top:20px;text-align:right;">
        <button id="btnConfirmSi" style="background:var(--primary);color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-size:0.95rem;margin-right:8px;">‚úÖ Aceptar</button>
      </div>
    </div>
  </div>
</main>

<footer style="padding:12px;text-align:center;color:var(--muted)">Desarrollado por Hugo ‚öì  | Firebase + Netlify</footer>

<script type="module">
  // 1. IMPORTS
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getFirestore, collection, getDocs, query, addDoc, doc, getDoc, setDoc, deleteDoc,
    orderBy, limit, where, writeBatch
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC8qPpRUTOP5Ef7pf4DYXkTCZnTWVQwHHU",
    authDomain: "gestion-stock-transportes.firebaseapp.com",
    projectId: "gestion-stock-transportes",
    storageBucket: "gestion-stock-transportes.appspot.com",
    messagingSenderId: "47030902783",
    appId: "1:47030902783:web:ec7217b290a3d2fbad91ca"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // 2. VARIABLES DOM
  const tablaBody       = document.querySelector("#tabla-stock tbody");
  const disponibilidadCard = document.getElementById("disponibilidadCard");
  const noResults       = document.getElementById("noResults");
  const btnBuscar       = document.getElementById("btnBuscar");
  const btnGuardar      = document.getElementById("btnGuardar");
  const btnLimpiarPrincipal = document.getElementById("btnLimpiarPrincipal");
  const btnLimpiarBusqueda  = document.getElementById("btnLimpiarBusqueda");
  const exportCsvBtn    = document.getElementById("exportCsv");
  const clearVisibleBtn = document.getElementById("clearVisible");
  const adminBtn        = document.getElementById("adminBtn");
  const adminPanel      = document.getElementById("adminPanel");
  const btnHistorial    = document.getElementById("btnHistorial");
  const historialDiv    = document.getElementById("historial");
  const tablaMov        = document.querySelector("#tabla-movimientos tbody");
  const btnExportAll    = document.getElementById("btnExportAll");
  const darkToggle      = document.getElementById("darkToggle");

  // 3. TEMA
  function applyTheme(theme) {
    if (theme === 'dark') document.documentElement.setAttribute('data-theme', 'dark');
    else document.documentElement.removeAttribute('data-theme');
    localStorage.setItem('theme', theme);
  }
  darkToggle.addEventListener('click', () => {
    const cur = localStorage.getItem('theme') === 'dark' ? 'light' : 'dark';
    applyTheme(cur);
  });
  applyTheme(localStorage.getItem('theme') || 'light');

  // 4. UTILS
  function csvFromArray(rows) {
    return rows.map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(",")).join("\n");
  }
  function downloadFile(name, content, type = 'text/csv') {
    const blob = new Blob([content], { type });
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement('a'), { href: url, download: name });
    a.click();
    URL.revokeObjectURL(url);
  }
  function norm(str) {
    return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toUpperCase().trim().replace(/[^A-Z0-9\/\+_]/g, '');
  }

  // ‚ö†Ô∏è FUNCI√ìN PRINCIPAL CORREGIDA
  async function buscarYMostrar() {
    tablaBody.innerHTML = "";
    noResults.style.display = 'none';
    const fecha     = document.getElementById("filtroFecha").value;
    const puertoRaw = document.getElementById("filtroPuerto").value.trim().toUpperCase();

    // 1. Buscar excepciones
    let qEx = collection(db, "excepciones");
    const constraintsEx = [];
    if (fecha)     constraintsEx.push(where("fecha",  "==", fecha));
    if (puertoRaw) constraintsEx.push(where("puerto", "==", puertoRaw));
    qEx = query(qEx, ...constraintsEx);
    const snapEx = await getDocs(qEx);

    let excepcionesTexto = [];
    for (const s of snapEx.docs) {
      const d = s.data();
      excepcionesTexto.push({
	cliente: d.cliente || '',
        proveedor: d.proveedor || '',
        localidad: d.localidad || '',
        disponibilidad: d.disponibilidad || 0,
        acuerdo: d.acuerdo || 0,
        notasAcum: d.notasAcum || ''
      });
    }

// 2. ORDENAR POR CLIENTE A-Z
  excepcionesTexto.sort((a, b) => a.cliente.localeCompare(b.cliente));


    
    // 2. Buscar stock general
    let qGen = collection(db, "stockGeneral");
    const constraintsGen = [];
    if (fecha)     constraintsGen.push(where("fecha",  "==", fecha));
    if (puertoRaw) constraintsGen.push(where("puerto", "==", puertoRaw));
    qGen = query(qGen, ...constraintsGen);
    const snapGen = await getDocs(qGen);

    if (snapGen.empty && excepcionesTexto.length === 0) {
      noResults.style.display = 'block';
      disponibilidadCard.classList.add('hidden');
      return;
    }

    disponibilidadCard.classList.remove('hidden');

    for (const docGen of snapGen.docs) {
      const d = docGen.data();
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${d.proveedor || ''}</td>
        <td>${d.acuerdo ?? ''}</td>
        <td><strong>${d.disponibilidad ?? 0}</strong></td>
        <td>${d.puerto || ''}</td>
        <td>-</td>
        <td>${d.fecha ? d.fecha.split('-').reverse().join('-') : ''}</td>
        <td>${d.usuario || ''}</td>
        <td class="actions"><button class="btnEliminarGeneral" data-id="${docGen.id}" style="background:#dc3545">‚ùå</button></td>
`;
      tablaBody.appendChild(tr);
    }
  }

 btnBuscar.addEventListener('click', async () => {
  const fecha     = document.getElementById("filtroFecha").value;
  const puertoRaw = document.getElementById("filtroPuerto").value;

  // 1. Excepciones (tu c√≥digo ya hecho)
  let qEx = collection(db, "excepciones");
  const constraintsEx = [];
  if (fecha)     constraintsEx.push(where("fecha",  "==", fecha));
  if (puertoRaw) constraintsEx.push(where("puerto", "==", puertoRaw));
  qEx = query(qEx, ...constraintsEx);
  const snapEx = await getDocs(qEx);

  let excepcionesTexto = [];
  snapEx.forEach(s => {
    const d = s.data();
    excepcionesTexto.push({
      cliente: d.cliente || '',
      proveedor: d.proveedor || '',
      localidad: d.localidad || '',
      disponibilidad: d.disponibilidad || 0,
      acuerdo: d.acuerdo || 0,
      notasAcum: d.notasAcum || ''
    });
  });
  

document.addEventListener('click', async (e) => {
  if (e.target.classList.contains('btnEliminarGeneral')) {
    console.log('üéØ Bot√≥n pulsado');
    console.log('üìÑ data-id:', e.target.dataset.id);
    const id = e.target.dataset.id;
    if (!id) { console.warn('‚ö†Ô∏è ID vac√≠o'); return; }

    if (!confirm('¬øEliminar stock general?')) {
      console.log('‚ùå Usuario cancel√≥');
      return;
    }

    try {
      console.log('üóëÔ∏è Borrando...', id);
      await deleteDoc(doc(db, 'stockGeneral', id));
      console.log('‚úÖ Borrado en Firestore');
      e.target.closest('tr').remove();
      console.log('üßπ Fila eliminada del DOM');
    } catch (err) {
      console.error('üí• Error al borrar:', err.code, err.message);
    }
  }
});

  // 2. ORDENAR POR CLIENTE A-Z
   excepcionesTexto.sort((a, b) => a.cliente.localeCompare(b.cliente));

  // 3. MOSTRAR MODAL SI HAY EXCEPCIONES
 if (excepcionesTexto.length > 0) {
    const modal = document.getElementById('modalConfirm');
    const tbody = document.querySelector('#tablaConfirmEx tbody');
    tbody.innerHTML = '';
    excepcionesTexto.forEach(e => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="padding:8px 10px;border:1px solid #ddd;">${e.cliente}</td>
        <td style="padding:8px 10px;border:1px solid #ddd;">${e.proveedor}</td>
        <td style="padding:8px 10px;border:1px solid #ddd;">${e.acuerdo}</td>
        <td style="padding:8px 10px;border:1px solid #ddd;background:#d4f8e0;font-weight:600;">${e.disponibilidad}</td>
        <td style="padding:8px 10px;border:1px solid #ddd;">${e.localidad}</td>
        <td style="padding:8px 10px;border:1px solid #ddd;">${e.notasAcum}</td>
      `;
      tbody.appendChild(tr);
    });
    modal.classList.remove('hidden');
    await new Promise(resolve => {
      document.getElementById('btnConfirmSi').onclick = () => {
        modal.classList.add('hidden');
        resolve(true);
      };
    });
  }


  // 4. CONTINUAR con la b√∫squeda normal
  await buscarYMostrar();
  reservaCard.classList.remove('hidden');   // ‚¨ÖÔ∏è muestra gesti√≥n
  await cargarProveedoresYFijarPuerto();    // ‚¨ÖÔ∏è llena selects
});

btnLimpiarBusqueda.addEventListener('click', () => {
  document.querySelectorAll('#filtroFecha,#filtroPuerto').forEach(i => i.value = '');
  tablaBody.innerHTML = '';
  disponibilidadCard.classList.add('hidden');
  noResults.style.display = 'none';
  reservaCard.classList.add('hidden'); // <-- oculta gesti√≥n
});
btnLimpiarPrincipal.addEventListener('click', () => {
  document.querySelectorAll('#cantidad,#fechaInput,#usuarioInput').forEach(i => i.value = '');
  document.getElementById('proveedor').selectedIndex = 0;
  document.getElementById('puertoInput').selectedIndex = 0;
});

adminBtn.addEventListener('click', async () => {
    const pw = prompt('Introduce contrase√±a admin:');
    if (pw === 'admin123') {
      adminPanel.style.display = adminPanel.style.display === 'block' ? 'none' : 'block';
    } else {
      alert('Contrase√±a incorrecta.');
    }
  });

/* ---------- GUARDAR (stockGeneral + excepciones) ---------- */
btnGuardar.addEventListener('click', async () => {
  const proveedor = norm(document.getElementById('proveedor').value.trim());
  const cantidad  = -parseInt(document.getElementById('cantidad').value);
  const fecha     = document.getElementById('fechaInput').value;
  const puerto    = norm(document.getElementById('puertoInput').value);
  const usuario   = document.getElementById('usuarioInput').value.trim();

  if (!proveedor || isNaN(cantidad) || !fecha || !puerto || !usuario) {
    alert('‚ùå Rellena todos los campos correctamente.');
    return;
  }

  try {
    // 1. Registro en movimientos
    await addDoc(collection(db, 'movimientos'), {
      proveedor,
      cantidad,
      fecha,
      puerto,
      usuario,
      timestamp: new Date()
    });

    // 2. Actualizar stockGeneral
    const batch = writeBatch(db);
    const genId  = `${proveedor}::${fecha}::${puerto}`;
    const genRef = doc(db, 'stockGeneral', genId);
    const genSnap = await getDoc(genRef);

    const dispActual = genSnap.exists() ? (genSnap.data().disponibilidad || 0) : 0;
    const nuevoDisp  = dispActual + cantidad;

    batch.set(genRef, {
      proveedor,
      proveedorNorm: proveedor,
      fecha,
      puerto,
      puertoNorm: puerto,
      disponibilidad: nuevoDisp,
      acuerdo: genSnap.exists() ? (genSnap.data().acuerdo ?? nuevoDisp) : nuevoDisp,
      usuario
    }, { merge: true });

    // 3. Restar tambi√©n en todas las excepciones que coincidan
    const qEx = query(
      collection(db, 'excepciones'),
      where('proveedor', '==', proveedor),
      where('fecha', '==', fecha),
      where('puerto', '==', puerto)
    );
    const exSnap = await getDocs(qEx);
    exSnap.forEach(docEx => {
      const exData = docEx.data();
      const actualEx = exData.disponibilidad || 0;
      const nuevoEx  = Math.max(0, actualEx + cantidad); // no negativo
      batch.set(docEx.ref, { disponibilidad: nuevoEx }, { merge: true });
    });

    await batch.commit();
    alert('‚úÖ Stock general y excepciones actualizados.');
    btnLimpiarPrincipal.click();
    if (!disponibilidadCard.classList.contains('hidden')) await buscarYMostrar();
  } catch (err) {
    console.error('üí• Error al guardar:', err);
    alert('‚ùå Error al guardar: ' + err.message);
  }
});
/* ---------- VER HISTORIAL (FECHA - PUERTO - PROV - MOV - CANT - USER) ---------- */
btnHistorial.addEventListener('click', async () => {
  // √∫ltimos 500 movimientos, m√°s recientes primero
  const q = query(collection(db, 'movimientos'), orderBy('timestamp', 'desc'), limit(500));
  const snap = await getDocs(q);

  // cabecera de la tabla
  tablaMov.innerHTML = '';
  snap.forEach(docSnap => {
    const d = docSnap.data();
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${d.fecha.split('-').reverse().join('/')}</td>
      <td>${d.puerto || ''}</td>
      <td>${d.proveedor || ''}</td>
      <td>${d.cantidad > 0 ? 'SUMA' : 'RESTA'}</td>
      <td>${d.cantidad}</td>
      <td>${d.usuario || ''}</td>
    `;
    tablaMov.appendChild(tr);
  });

  historialDiv.style.display = 'block';
});

/* ---------- EXPORTAR TODO (MISMA TABLA QUE SE VE) ---------- */
btnExportAll.addEventListener('click', async () => {
  // mismos 500 movimientos que se cargan en "Ver historial"
  const q = query(collection(db, 'movimientos'), orderBy('timestamp', 'desc'), limit(500));
  const snap = await getDocs(q);

  const rows = [['Fecha', 'Puerto', 'Proveedor', 'Movimiento', 'Cantidad', 'Usuario']];
  snap.forEach(docSnap => {
    const d = docSnap.data();
    rows.push([
      d.fecha.split('-').reverse().join('/'), // DD/MM/YYYY
      d.puerto || '',
      d.proveedor || '',
      d.cantidad > 0 ? 'SUMA' : 'RESTA',
      d.cantidad,
      d.usuario || ''
    ]);
  });

  downloadFile('historial_completo.csv', csvFromArray(rows));
});

async function cargarProveedoresYFijarPuerto() {
  const puertoElegido = document.getElementById('filtroPuerto').value;
  const fechaElegida   = document.getElementById('filtroFecha').value;
  if (!puertoElegido || !fechaElegida) return;

  // Fijar puerto en reserva
  const puertoInputSelect = document.getElementById('puertoInput');
  puertoInputSelect.innerHTML = `<option value="${puertoElegido}">${puertoElegido}</option>`;

  // Proveedores que existen para esa fecha y puerto
  const proveedorSelect = document.getElementById('proveedor');
  const q = query(
    collection(db, 'stockGeneral'),
    where('puerto', '==', puertoElegido),
    where('fecha', '==', fechaElegida)
  );
  const snap = await getDocs(q);
  const set = new Set();
  snap.forEach(doc => set.add(doc.data().proveedor));
  proveedorSelect.innerHTML = '';
  set.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p;
    opt.textContent = p;
    proveedorSelect.appendChild(opt);
  });
  if (set.size === 0) {
    const opt = document.createElement('option');
    opt.value = '';
    opt.textContent = '(Sin proveedores)';
    proveedorSelect.appendChild(opt);
  }
}
</script>
</body>
</html>
